#!/usr/local/bin/luajit
dofile('/usr/local/bin/luaenv')
--[[
pbtest login
pbtest login.login
--]]

Mod.load('mod/pbproto')

local url = arg[1]

local mod_name = nil
local func_name = nil
if url then
    local pats = string.split(url, '.')
    mod_name = pats[1]
    func_name = pats[2]
end

Pbc.import_dir('proto')

function main(dir)
    local files = File.listdir(dir)
    for _, file in pairs(files) do
        if file.type == 'dir' then
            Mod.load(string.format('%s/%s', dir, file.name))
        end
    end
    run_func(mod_name, func_name)
    os.exit(0)
end

function run_func(mod_name, func_name)
    local mod = _G[string.cap(mod_name)]
    if not mod then
        logerr('mod(%s) not found', mod_name)
        return
    end
    local func = mod[func_name]
    if not func then
        logerr('func(%s.%s) not found', mod_name, func_name)
        return
    end
    local player = {uid = 333}
    func(player)
    print(string.format('(ok)run %s.%s', mod_name, func_name))
end

main('pbtest')
